# HG changeset patch
# Parent baf25d48d75eab1aec9c2f4f4d1935cbd4654e00
# User Anant Narayanan <anant@kix.in>
Abstract media engine interface

diff --git a/content/media/Makefile.in b/content/media/Makefile.in
--- a/content/media/Makefile.in
+++ b/content/media/Makefile.in
@@ -48,16 +48,17 @@ XPIDL_MODULE = content_media
 
 XPIDLSRCS = \
   nsIDOMMediaStream.idl \
   $(NULL)
 
 EXPORTS = \
   AudioSegment.h \
   FileBlockCache.h \
+  MediaEngine.h \
   MediaResource.h \
   MediaSegment.h \
   MediaStreamGraph.h \
   nsAudioAvailableEventManager.h \
   nsBuiltinDecoder.h \
   nsBuiltinDecoderStateMachine.h \
   nsBuiltinDecoderReader.h \
   nsDOMMediaStream.h \
@@ -69,16 +70,17 @@ EXPORTS = \
   VideoFrameContainer.h \
   VideoUtils.h \
   VideoSegment.h \
   $(NULL)
 
 CPPSRCS = \
   AudioSegment.cpp \
   FileBlockCache.cpp \
+  MediaEngine.cpp \
   MediaResource.cpp \
   MediaStreamGraph.cpp \
   nsAudioAvailableEventManager.cpp \
   nsBuiltinDecoder.cpp \
   nsBuiltinDecoderStateMachine.cpp \
   nsBuiltinDecoderReader.cpp \
   nsDOMMediaStream.cpp \
   nsMediaCache.cpp \
diff --git a/content/media/MediaEngine.cpp b/content/media/MediaEngine.cpp
new file mode 100644
--- /dev/null
+++ b/content/media/MediaEngine.cpp
@@ -0,0 +1,82 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#include "MediaEngine.h"
+
+namespace mozilla {
+
+NS_IMPL_ISUPPORTS1(nsDOMMediaStreamHelper, nsIDOMMediaStream)
+
+/* Override nsDOMMediaStream. Instantiate a real nsDOMMediaStream when called */
+MediaStream*
+nsDOMMediaStreamHelper::GetStream()
+{ 
+  EnsureRealStream();
+  return mDOMStream->GetStream();
+}
+
+bool
+nsDOMMediaStreamHelper::IsFinished()
+{
+  EnsureRealStream();
+  return mDOMStream->IsFinished();
+}
+
+nsIPrincipal*
+nsDOMMediaStreamHelper::GetPrincipal()
+{
+  EnsureRealStream();
+  return mDOMStream->GetPrincipal();
+}
+
+bool
+nsDOMMediaStreamHelper::CombineWithPrincipal(nsIPrincipal* aPrincipal)
+{
+  EnsureRealStream();
+  return mDOMStream->CombineWithPrincipal(aPrincipal);
+}
+
+NS_IMETHODIMP
+nsDOMMediaStreamHelper::GetCurrentTime(double *aCurrentTime)
+{
+  EnsureRealStream();
+  return mDOMStream->GetCurrentTime(aCurrentTime);
+}
+
+/**
+ * Currently, we support only a single audio and video track in each stream.
+ */
+enum {
+  kVideoTrack,
+  kAudioTrack
+};
+
+nsresult
+nsDOMMediaStreamHelper::EnsureRealStream()
+{
+  if (mDOMStream) {
+    return NS_OK;
+  }
+
+  mDOMStream = nsDOMMediaStream::CreateInputStream();
+  SourceMediaStream *mStream = mDOMStream->GetStream()->AsSourceStream();
+
+  nsresult rv;
+    
+  if (mVideo) {
+    TrackID vId = kVideoTrack;
+    rv = mVideo->Start(mStream, vId);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  if (mAudio) {
+    TrackID aId = kAudioTrack;
+    rv = mAudio->Start(mStream, aId);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return NS_OK;
+}
+
+}
diff --git a/content/media/MediaEngine.h b/content/media/MediaEngine.h
new file mode 100644
--- /dev/null
+++ b/content/media/MediaEngine.h
@@ -0,0 +1,142 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef MEDIAENGINE_H_
+#define MEDIAENGINE_H_
+
+#include "nsDOMMediaStream.h"
+#include "MediaStreamGraph.h"
+
+namespace mozilla {
+
+/**
+ * Abstract interface for managing audio and video devices. Each platform
+ * must implement a concrete class that will map these classes and methods
+ * to the appropriate backend. For example, on Desktop platforms, these will
+ * correspond to equivalent webrtc (GIPS) calls, and on B2G they will map to
+ * a Gonk interface.
+ */
+class nsDOMMediaStreamHelper;
+class MediaEngineVideoSource;
+class MediaEngineAudioSource;
+
+class MediaEngine
+{
+public:
+  virtual ~MediaEngine() {};
+  
+  /* Return an array of video sources. Also include devices that are
+   * currently unavailable. */
+  virtual MediaEngineVideoSource* EnumerateVideoDevices(PRInt32&) = 0;
+
+  /* Return an array of audio sources. Also include devices that are
+   * currently unavailable. */
+  virtual MediaEngineAudioSource* EnumerateAudioDevices(PRInt32&) = 0;
+};
+
+/**
+ * Common abstract base class for audio and video sources.
+ */
+class MediaEngineSource
+{
+public:
+  virtual ~MediaEngineSource() {};
+  
+  virtual nsresult GetName(nsAString&) = 0;
+
+  /* This call reserves but does not start the device. Use the nsDOMMediaHelper
+   * class and return an instance. It will automatically call Start() when
+   * needed to make a real MediaStream object. */
+  virtual nsDOMMediaStreamHelper* Allocate() = 0;
+
+  /* Release the device back to the system. */
+  virtual nsresult Deallocate() = 0;
+
+  /* Start the device and add the track to the provided SourceMediaStream, with
+   * the provided TrackID. You may start appending data to the track
+   * immediately after. */
+  virtual nsresult Start(SourceMediaStream*, TrackID&) = 0;
+  
+  /* Stop the device and release the corresponding MediaStream */
+  virtual nsresult Stop() = 0;
+  
+  /* It is an error to call Start() before an Allocate(), and Stop() before
+   * a Start(). Only Allocate() may be called after a Deallocate(). */
+};
+
+/**
+ * Video source and friends.
+ */
+enum mediaEngineVideoCodecType {
+  kVideoCodecH263,
+  kVideoCodecVP8,
+  kVideoCodecI420
+};
+
+typedef struct mediaEngineVideoOptions {
+  bool interlaced;
+  unsigned int width;
+  unsigned int height;
+  unsigned int maxFPS;
+  mediaEngineVideoCodecType codecType;
+} mediaEngineVideoOptions;
+
+class MediaEngineVideoSource : public MediaEngineSource
+{
+public:
+  virtual ~MediaEngineVideoSource() {};
+  /* Fills the given struct with appropriate values for all fields. */
+  virtual nsresult GetOptions(mediaEngineVideoOptions*) = 0;
+};
+
+/**
+ * Audio source and friends.
+ */
+class MediaEngineAudioSource : public MediaEngineSource
+{
+public:
+  virtual ~MediaEngineAudioSource() {};
+};
+
+/**
+ * Helper class, represents an nsIDOMMediaStream object that corresponds to
+ * input from a device that has been Allocate()d but not Start()ed. When the
+ * MediaStream is actually used by content, we will call Start() on the
+ * corresponding device and start pushing frames.
+ */
+class nsDOMMediaStreamHelper : public nsIDOMMediaStream
+{
+public:
+  nsDOMMediaStreamHelper(MediaEngineVideoSource *aSrc) :
+    mDOMStream(nsnull), mVideo(aSrc), mAudio(nsnull) {}
+  
+  nsDOMMediaStreamHelper(MediaEngineAudioSource *aSrc) :
+    mDOMStream(nsnull), mVideo(nsnull), mAudio(aSrc) {}
+
+  nsDOMMediaStreamHelper(
+    MediaEngineVideoSource *aVideo, MediaEngineAudioSource *aAudio):
+    mDOMStream(nsnull), mVideo(aVideo), mAudio(aAudio) {}
+
+  ~nsDOMMediaStreamHelper(){};
+
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIDOMMEDIASTREAM
+
+  /* Methods from nsDOMMediaStream */
+  bool IsFinished();
+  MediaStream* GetStream();
+  nsIPrincipal* GetPrincipal();
+  bool CombineWithPrincipal(nsIPrincipal* aPrincipal);
+
+protected:
+  nsCOMPtr<nsDOMMediaStream> mDOMStream;
+  MediaEngineVideoSource* mVideo;
+  MediaEngineAudioSource* mAudio;
+
+  nsresult EnsureRealStream();
+};
+
+}
+
+#endif /* MEDIAENGINE_H_ */
\ No newline at end of file
